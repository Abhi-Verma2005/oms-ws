name: Deploy Unified Stack

on:
  push:
    branches: [ "main" ]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Prepare deploy artifacts
        run: |
          mkdir -p deploy_bundle
          cp -R docker-compose-unified.yml deploy_bundle/
          cp -R nginx-unified.conf deploy_bundle/
          cp -R deploy-unified.sh deploy_bundle/
          cp -R oms-new deploy_bundle/oms-new
          cp -R oms-landing deploy_bundle/oms-landing
          cp -R oms-ws deploy_bundle/oms-ws

      - name: Copy bundle to server
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_KEY }}
          port: ${{ secrets.SSH_PORT }}
          source: "deploy_bundle/*"
          target: "~/unified-deploy"
          overwrite: true

      - name: Create env file on server
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_KEY }}
          port: ${{ secrets.SSH_PORT }}
          script: |
            set -euo pipefail
            cd ~/unified-deploy
            # Write .env from GitHub Secrets if provided
            cat > .env << 'EOF'
            # Example unified env; ensure all values are set in repository secrets
            DATABASE_URL=${{ secrets.DATABASE_URL }}
            AUTH_SECRET=${{ secrets.AUTH_SECRET }}
            AUTH_URL=${{ secrets.AUTH_URL }}
            AUTH_RATE_LIMIT_MAX=${{ secrets.AUTH_RATE_LIMIT_MAX }}
            AUTH_RATE_LIMIT_WINDOW=${{ secrets.AUTH_RATE_LIMIT_WINDOW }}
            AUTH_GOOGLE_ID=${{ secrets.AUTH_GOOGLE_ID }}
            AUTH_GOOGLE_SECRET=${{ secrets.AUTH_GOOGLE_SECRET }}
            NEXT_PUBLIC_GEMINI_API_KEY=${{ secrets.NEXT_PUBLIC_GEMINI_API_KEY }}
            STRIPE_SECRET_KEY=${{ secrets.STRIPE_SECRET_KEY }}
            WS_PORT=${{ secrets.WS_PORT }}
            STRIPE_WEBHOOK_SECRET=${{ secrets.STRIPE_WEBHOOK_SECRET }}
            STRIPE_CURRENCY=${{ secrets.STRIPE_CURRENCY }}
            NEXT_PUBLIC_WEBSOCKET_URL=${{ secrets.NEXT_PUBLIC_WEBSOCKET_URL }}
            NEXT_PUBLIC_AUTH_URL=${{ secrets.NEXT_PUBLIC_AUTH_URL }}
            SMTP_HOST=${{ secrets.SMTP_HOST }}
            SMTP_PORT=${{ secrets.SMTP_PORT }}
            SMTP_USER=${{ secrets.SMTP_USER }}
            SMTP_PASS=${{ secrets.SMTP_PASS }}
            EMAIL_FROM=${{ secrets.EMAIL_FROM }}
            JWT_SECRET=${{ secrets.JWT_SECRET }}
            OPEN_AI_KEY=${{ secrets.OPEN_AI_KEY }}
            OPENAI_API_KEY=${{ secrets.OPENAI_API_KEY }}
            OUTREACH_API_URL=${{ secrets.OUTREACH_API_URL }}
            WP_DB_NAME=${{ secrets.WP_DB_NAME }}
            WP_DB_USER=${{ secrets.WP_DB_USER }}
            WP_DB_PASSWORD=${{ secrets.WP_DB_PASSWORD }}
            WP_DB_ROOT_PASSWORD=${{ secrets.WP_DB_ROOT_PASSWORD }}
            WP_DEBUG=${{ secrets.WP_DEBUG }}
            EOF
            chmod 600 .env || true

      - name: Run remote deploy script
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_KEY }}
          port: ${{ secrets.SSH_PORT }}
          script: |
            set -euo pipefail
            cd ~/unified-deploy
            chmod +x deploy-unified.sh || true
            ./deploy-unified.sh

